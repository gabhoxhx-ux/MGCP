{% extends "base.html" %}

{% block content %}
<div class="costos-indirectos">
    <h2>Gestión de Costos Indirectos</h2>

    <div class="agregar-costo">
        <h3>Registrar Nuevo Costo Indirecto</h3>
        <form id="formularioCosto" class="form-costo">
            <div class="form-row">
                <div class="form-group">
                    <label for="mes">Mes</label>
                    <select id="mes" required>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11" selected>Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="año">Año</label>
                    <input type="number" id="año" value="2025" required>
                </div>
                <div class="form-group">
                    <label for="monto">Monto ($)</label>
                    <input type="number" id="monto" step="0.01" required>
                </div>
            </div>
            <div class="form-group">
                <label for="descripcion">Descripción</label>
                <input type="text" id="descripcion" placeholder="Descripción de los costos indirectos">
            </div>
            <button type="submit" class="btn btn-primary">Registrar Costo</button>
        </form>
    </div>

    {% if costos %}
    <div class="listado-costos">
        <h3>Costos Indirectos Registrados</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Período</th>
                    <th>Monto</th>
                    <th>Descripción</th>
                    <th>Registrado por</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody>
                {% for costo in costos %}
                <tr>
                    <td>{{ costo.mes }}/{{ costo.año }}</td>
                    <td class="numero">{{ costo.monto|clp }}</td>
                    <td>{{ costo.descripcion }}</td>
                    <td>{{ costo.usuario }}</td>
                    <td>{{ costo.fecha_registro.strftime('%Y-%m-%d %H:%M') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<script>
document.getElementById('formularioCosto').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const datos = {
        mes: parseInt(document.getElementById('mes').value),
        año: parseInt(document.getElementById('año').value),
        monto: parseFloat(document.getElementById('monto').value),
        descripcion: document.getElementById('descripcion').value,
        usuario: 'Admin'
    };

    fetch('{{ url_for("agregar_costo") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(datos)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Costo registrado exitosamente');
            location.reload();
        } else {
            alert('❌ Error: ' + data.error);
        }
    });
});
</script>
{% endblock %}
